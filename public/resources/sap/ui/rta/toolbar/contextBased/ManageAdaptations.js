/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/restricted/_isEqual","sap/ui/base/ManagedObject","sap/ui/core/Fragment","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/m/ColumnListItem","sap/ui/rta/Utils","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/core/date/UI5Date"],function(t,e,a,o,n,i,r,s,l,d,c){"use strict";var u={Initial:0,Default:1024,Before:function(t){return t+1024},Between:function(t,e){return(t+e)/2},After:function(t){return t+.5}};var g=a.extend("sap.ui.rta.toolbar.contextBased.ManageAdaptations",{metadata:{properties:{toolbar:{type:"any"}}},constructor:function(){a.prototype.constructor.apply(this,arguments);this.oTextResources=this.getToolbar().getTextResources()}});g.prototype.openManageAdaptationDialog=function(){if(!this._oManageAdaptationDialogPromise){this._oManageAdaptationDialogPromise=o.load({name:"sap.ui.rta.toolbar.contextBased.ManageAdaptationsDialog",id:this.getToolbar().getId()+"_fragment--sapUiRta_manageAdaptationDialog",controller:{formatContextColumnCell:p.bind(this),formatContextColumnTooltip:h.bind(this),formatCreatedChangedOnColumnCell:f.bind(this),onLiveSearch:C.bind(this),moveUp:A.bind(this),moveDown:_.bind(this),onDropSelectedAdaptation:P.bind(this),onSaveReorderedAdaptations:w.bind(this),onClose:k.bind(this)}}).then(function(t){this._oManageAdaptationDialog=t;t.addStyleClass(r.getRtaStyleClassName());this.getToolbar().addDependent(this._oManageAdaptationDialog)}.bind(this))}else{v.call(this,false);O.call(this,true);R.call(this,false)}return this._oManageAdaptationDialogPromise.then(function(){this._oRtaInformation=this.getToolbar().getRtaInformation();return n.load({control:this._oRtaInformation.rootControl,layer:this._oRtaInformation.flexSettings.layer})}.bind(this)).then(function(t){this.oAdaptationsModel=n.getAdaptationsModel({control:this._oRtaInformation.rootControl,layer:this._oRtaInformation.flexSettings.layer});this.oAdaptationsModel.updateAdaptations(t.adaptations);this.oReferenceAdaptationsData=JSON.parse(JSON.stringify(t));this._oControlConfigurationModel=new d({isTableItemSelected:false});this._oManageAdaptationDialog.setModel(this.oAdaptationsModel,"contextBased");this._oManageAdaptationDialog.setModel(this._oControlConfigurationModel,"controlConfiguration");b(this.oAdaptationsModel);B.call(this).attachSelectionChange(m.bind(this));return this._oManageAdaptationDialog.open()}.bind(this)).catch(function(e){t.error(e.stack);var a="MSG_LREP_TRANSFER_ERROR";var o={titleKey:"BTN_MANAGE_APP_CTX"};o.details=e.userMessage;r.showMessageBox("error",a,o)})};function p(t){return t.length+" "+(t.length>1?this.oTextResources.getText("TXT_TABLE_CONTEXT_CELL_ROLES"):this.oTextResources.getText("TXT_TABLE_CONTEXT_CELL_ROLE"))}function h(t){return t.join("\n")}function f(t,e){var a=c.getInstance(e);var o={year:"numeric",month:"short",day:"numeric"};var n=sap.ui.getCore().getConfiguration().getLanguage();return t+"\n"+a.toLocaleDateString(n,o)}function m(t){if(t.getParameter("selected")===true){this._oControlConfigurationModel.setProperty("/isTableItemSelected",true);if(L.call(this)){v.call(this,true)}}}function v(t){var e=S.call(this,"moveUpButton");var a=S.call(this,"moveDownButton");e.setEnabled(t);a.setEnabled(t)}function C(t){var e;var a=t.getSource().getValue();var o=B.call(this);var n=D.call(this);var i=I.call(this);if(a&&a.length>0){v.call(this,false);O.call(this,false);var r=new s("title",l.Contains,a);var d=new s({path:"contexts/role",test:function(t){return t.some(function(t){return t.includes(a.toUpperCase())})}});var c=new s("createdBy",l.Contains,a);var u=new s("changedBy",l.Contains,a);e=new s([r,d,c,u]);if(i.toUpperCase().includes(a.toUpperCase())){n.setVisible(true)}else{n.setVisible(false)}}else{O.call(this,true);if(this._oControlConfigurationModel.getProperty("/isTableItemSelected")){v.call(this,true)}n.setVisible(true)}var g=o.getBinding("items");g.filter(e,"Application")}function A(t){y.call(this,"Up");t.getSource().focus()}function _(t){y.call(this,"Down");t.getSource().focus()}function M(t,e){return t.rank-e.rank}function T(t){var e=t.getProperty("/adaptations")||[];e.sort(M);t.setProperty("/adaptations",e);t.refresh(true)}function b(t){var e=t.getProperty("/adaptations")||[];e.forEach(function(t,e){t.rank=e+1});t.setProperty("/adaptations",e)}function y(t){var e=B.call(this);var a=e.getSelectedItem(0);var o=a.getBindingContext("contextBased");var n=e.indexOfItem(a)+(t==="Up"?-1:1);var i=e.getItems()[n];var r=i?i.getBindingContext("contextBased"):undefined;if(!r){return}var s=r.getProperty("rank");var l=o.getProperty("rank");this.oAdaptationsModel.setProperty("rank",s,o);this.oAdaptationsModel.setProperty("rank",l,r);T(this.oAdaptationsModel);e.getItems()[n].setSelected(true).focus();R.call(this,true)}function P(t){var e=t.getParameter("draggedControl");var a=e.getBindingContext("contextBased");if(!a){return}var o=u.Default;var n=t.getParameter("droppedControl");if(n instanceof i){var r=t.getParameter("dropPosition");var s=n.getBindingContext("contextBased");var l=s.getProperty("rank");var d=n.getParent();var c=d.indexOfItem(n);if(s===a){return}var g=c+(r==="After"?1:-1);var p=d.getItems()[g];if(!p||g===-1){o=g===-1?.5:u[r](l)}else{var h=p.getBindingContext("contextBased");o=u.Between(l,h.getProperty("rank"))}}this.oAdaptationsModel.setProperty("rank",o,a);T(this.oAdaptationsModel);b(this.oAdaptationsModel);R.call(this,true)}function x(){return!e(this.oAdaptationsModel.getProperty("/adaptations").map(function(t){return t.id}),this.oReferenceAdaptationsData.adaptations.map(function(t){return t.id}))}function R(t){var e=S.call(this,"manageAdaptations-saveButton");e.setTooltip(t?"":this.oTextResources.getText("TOOLTIP_APP_CTX_DIALOG_SAVE"));e.setEnabled(t)}function B(){return S.call(this,"manageAdaptationsTable")}function S(t){return this.getToolbar().getControl("manageAdaptationDialog--"+t)}function D(){return S.call(this,"defaultContext")}function I(){return S.call(this,"defaultApplicationTitle").getProperty("text")}function E(){return S.call(this,"searchField")}function L(){return E.call(this).getValue().length===0}function O(t){B.call(this).getDragDropConfig()[0].setEnabled(t)}function w(){if(x.call(this)){var e=this.getToolbar().getRtaInformation();var a=this.oAdaptationsModel.getProperty("/adaptations").map(function(t){return t.id});n.reorder({control:e.rootControl,layer:e.flexSettings.layer,parameters:{priorities:a}}).catch(function(e){t.error(e.stack);var a="MSG_LREP_TRANSFER_ERROR";var o={titleKey:"BTN_MANAGE_APP_CTX"};o.details=e.userMessage;r.showMessageBox("error",a,o)})}k.call(this)}function k(){this._oControlConfigurationModel.setProperty("/isTableItemSelected",false);E.call(this).setValue("");var t=B.call(this);t.getBinding("items").filter([]);t.removeSelections();D.call(this).setVisible(true);this._oManageAdaptationDialog.close()}return g});
//# sourceMappingURL=ManageAdaptations.js.map