/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/plugin/Plugin","sap/ui/rta/plugin/RenameHandler","sap/ui/rta/Utils","sap/ui/dt/ElementOverlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/dt/Util","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/variants/VariantManagement","sap/ui/fl/write/api/ContextSharingAPI","sap/ui/base/ManagedObject","sap/base/Log","sap/m/MessageBox"],function(t,e,a,n,i,r,o,s,l,g,u,d,c,m,p){"use strict";n.prototype._variantManagement=undefined;n.prototype.getVariantManagement=function(){return this._variantManagement};n.prototype.setVariantManagement=function(t){this._variantManagement=t};n.prototype.hasVariantManagement=function(){return!!this._variantManagement};function h(t){var e=t.getElement().getManageDialog();if(e&&!e.bIsDestroyed){e.destroy()}}var f=t.extend("sap.ui.rta.plugin.ControlVariant",{metadata:{library:"sap.ui.rta",properties:{oldValue:"string"},associations:{},events:{}}});function v(t){var e=t.getElement();var a=t.getDesignTimeMetadata();var n=this._getVariantModel(e);var i=t.getVariantManagement();return this.getCommandFactory().getCommandFor(e,"save",{model:n},a,i)}function V(t,e,a,n){var i=t.getElement();var r=t.getDesignTimeMetadata();return this.getCommandFactory().getCommandFor(i,"switch",{targetVariantReference:e,sourceVariantReference:a,discardVariantContent:n},r)}f.prototype.registerElementOverlay=function(a){var n=a.getElement();var r;t.prototype.registerElementOverlay.apply(this,arguments);if(n instanceof u){var o=n.getFor();var l;var g=s.getAppComponentForControl(n);var d=n.getId();r=g.getLocalId(d)||d;a.setVariantManagement(r);if(!o||Array.isArray(o)&&o.length===0){return}l=!Array.isArray(o)?[o]:o;l.forEach(function(t){var e=t instanceof c?t:sap.ui.getCore().byId(t);var a=i.getOverlay(e);this._propagateVariantManagement(a,r)}.bind(this));a.attachEvent("editableChange",e._manageClickEvent,this);h(a)}else if(!a.getVariantManagement()){r=this._getVariantManagementFromParent(a);if(r){a.setVariantManagement(r);a.attachEvent("editableChange",e._manageClickEvent,this)}}};f.prototype._isPersonalizationMode=function(){return this.getCommandFactory().getFlexSettings().layer===l.USER};f.prototype._propagateVariantManagement=function(t,e){var a=[];t.setVariantManagement(e);a=r.getAllChildOverlays(t);a.forEach(function(t){a=a.concat(this._propagateVariantManagement(t,e))}.bind(this));return a};f.prototype._getVariantManagementFromParent=function(t){var e=t.getVariantManagement();if(!e&&t.getParentElementOverlay()){return this._getVariantManagementFromParent(t.getParentElementOverlay())}return e};f.prototype.deregisterElementOverlay=function(a){if(this._isVariantManagementControl(a)){h(a)}a.detachEvent("editableChange",e._manageClickEvent,this);a.detachBrowserEvent("click",e._onClick,this);this.removeFromPluginsList(a);t.prototype.deregisterElementOverlay.apply(this,arguments)};f.prototype._getVariantModel=function(t){var e=s.getAppComponentForControl(t);return e?e.getModel(g.getVariantModelName()):undefined};f.prototype._isEditable=function(t){if(this._isPersonalizationMode()){return false}return this._isVariantManagementControl(t)&&this.hasStableId(t)};f.prototype._isVariantManagementControl=function(t){var e=t.getElement();var a=e.getAssociation("for");return!!(a&&e instanceof u)};f.prototype.isVariantSwitchAvailable=function(t){return this._isVariantManagementControl(t)};f.prototype.isVariantSwitchEnabled=function(t){var e=t[0];var a=[];if(this._isVariantManagementControl(e)){var n=e.getElement();var i=e.getVariantManagement?e.getVariantManagement():undefined;if(!i){return false}var r=this._getVariantModel(n);if(r){a=r.getData()[i].variants.reduce(function(t,e){if(e.visible){return t.concat(e)}return t},[])}var o=a.length>1;return o}return false};f.prototype.setDesignTime=function(t){e._setDesignTime.call(this,t)};f.prototype.isRenameAvailable=function(t){return this._isVariantManagementControl(t)};f.prototype.isRenameEnabled=function(t){return this._isVariantManagementControl(t[0])};f.prototype.isVariantSaveAvailable=function(t){return this._isVariantManagementControl(t)};f.prototype.isVariantSaveEnabled=function(t){var e=t[0];var a=e.getElement();var n=this._getVariantModel(a);var i=e.getVariantManagement();return n.oData[i]&&n.oData[i].modified};f.prototype.isVariantSaveAsAvailable=function(t){return this._isVariantManagementControl(t)};f.prototype.isVariantSaveAsEnabled=function(t){return this._isVariantManagementControl(t[0])};f.prototype.isVariantConfigureAvailable=function(t){return this._isVariantManagementControl(t)};f.prototype.isVariantConfigureEnabled=function(t){return this._isVariantManagementControl(t[0])};f.prototype.switchVariant=function(t,e,n){var i=t.getElement();var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");function s(a){if(a===p.Action.CANCEL){return}if(a===r.getText("BTN_MODIFIED_VARIANT_SAVE")){var o;this.getCommandFactory().getCommandFor(i,"composite").then(function(e){o=e;return v.call(this,t)}.bind(this)).then(function(a){o.addCommand(a);return V.call(this,t,e,n)}.bind(this)).then(function(t){o.addCommand(t);this.fireElementModified({command:o})}.bind(this))}if(a===r.getText("BTN_MODIFIED_VARIANT_DISCARD")){V.call(this,t,e,n,true).then(function(t){this.fireElementModified({command:t})}.bind(this))}}if(i.getModified()){p.warning(r.getText("MSG_CHANGE_MODIFIED_VARIANT"),{onClose:s.bind(this),actions:[r.getText("BTN_MODIFIED_VARIANT_SAVE"),r.getText("BTN_MODIFIED_VARIANT_DISCARD"),p.Action.CANCEL],emphasizedAction:r.getText("BTN_MODIFIED_VARIANT_SAVE"),styleClass:a.getRtaStyleClassName()})}else{V.call(this,t,e,n).then(function(t){this.fireElementModified({command:t})}.bind(this)).catch(function(t){throw o.createError("ControlVariant#switchVariant",t,"sap.ui.rta")})}};f.prototype.renameVariant=function(t){this.startEdit(t[0])};f.prototype.startEdit=function(t){var a=t.getDesignTimeMetadata().getData().variantRenameDomRef;e.startEdit.call(this,{overlay:t,domRef:a,pluginMethodName:"plugin.ControlVariant.startEdit"})};f.prototype.stopEdit=function(t){e._stopEdit.call(this,t,"plugin.ControlVariant.stopEdit")};f.prototype.createSaveCommand=function(t){var e=t[0];return v.call(this,e).then(function(t){this.fireElementModified({command:t})}.bind(this))};f.prototype.createSaveAsCommand=function(t){var e=t[0];var a=e.getElement();var n=e.getDesignTimeMetadata();var i=this._getVariantModel(a);var r=e.getVariantManagement();var o=i.getCurrentVariantReference(r);return this.getCommandFactory().getCommandFor(a,"saveAs",{sourceVariantReference:o,model:i},n,r).then(function(t){this.fireElementModified({command:t})}.bind(this))};f.prototype._emitLabelChangeEvent=function(){var t=e._getCurrentEditableFieldText.call(this);var a=this._oEditedOverlay;var n=a.getDesignTimeMetadata();var i=a.getElement();var r=a.getVariantManagement();return this._createSetTitleCommand({text:t,element:i,designTimeMetadata:n,variantManagementReference:r}).then(function(t){this.fireElementModified({command:t})}.bind(this))};f.prototype._createSetTitleCommand=function(t){this._oEditableControlDomRef.textContent=t.text;return this.getCommandFactory().getCommandFor(t.element,"setTitle",{newText:t.text},t.designTimeMetadata,t.variantManagementReference).catch(function(t){m.error("Error during rename: ",t)})};f.prototype._prepareOverlayForValueState=function(t,e){t.getValueState=function(){return"Error"};t.getValueStateText=function(){return e};t.getDomRefForValueStateMessage=function(){return this.$()}};f.prototype.configureVariants=function(t){var e=t[0];var n=e.getElement();var i=e.getVariantManagement();var r=this._getVariantModel(n);var s=e.getDesignTimeMetadata();var l=this.getCommandFactory().getFlexSettings();return r.manageVariants(n,i,l.layer,a.getRtaStyleClassName(),d.createComponent(l)).then(function(t){if(t.length>0){return this.getCommandFactory().getCommandFor(n,"configure",{control:n,changes:t},s,i)}return undefined}.bind(this)).then(function(t){if(t){this.fireElementModified({command:t})}}.bind(this)).catch(function(t){throw o.createError("ControlVariant#configureVariants",t,"sap.ui.rta")})};f.prototype.getMenuItems=function(t){var e=t[0];var a=[];if(this.isRenameAvailable(e)){a.push({id:"CTX_VARIANT_SET_TITLE",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_RENAME"),handler:this.renameVariant.bind(this),enabled:this.isRenameEnabled.bind(this),rank:210,icon:"sap-icon://edit"})}if(this.isVariantSaveAvailable(e)){a.push({id:"CTX_VARIANT_SAVE",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_SAVE"),handler:this.createSaveCommand.bind(this),enabled:this.isVariantSaveEnabled.bind(this),rank:220,icon:"sap-icon://save"})}if(this.isVariantSaveAsAvailable(e)){a.push({id:"CTX_VARIANT_SAVEAS",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_SAVEAS"),handler:this.createSaveAsCommand.bind(this),enabled:this.isVariantSaveAsEnabled.bind(this),rank:225,icon:"sap-icon://duplicate"})}if(this.isVariantConfigureAvailable(e)){a.push({id:"CTX_VARIANT_MANAGE",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_MANAGE"),handler:this.configureVariants.bind(this),enabled:this.isVariantConfigureEnabled.bind(this),startSection:true,rank:230,icon:"sap-icon://action-settings"})}if(this.isVariantSwitchAvailable(e)){var n=this._getVariantModel(e.getElement());var i=e.getVariantManagement();var r=n.getData()[i].variants.reduce(function(t,e){if(e.visible){var a=n.getData()[i].currentVariant===e.key;var r={id:e.key,text:e.title,icon:a?"sap-icon://accept":"blank",enabled:!a};return t.concat(r)}return t},[]);a.push({id:"CTX_VARIANT_SWITCH_SUBMENU",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_SWITCH"),handler:function(t,e){var a=e.eventItem.getParameters().item.getProperty("key");var r=t[0];var o=n.getData()[i].currentVariant;return this.switchVariant(r,a,o)}.bind(this),enabled:this.isVariantSwitchEnabled.bind(this),submenu:r,rank:240,icon:"sap-icon://switch-views"})}return a};f.prototype.getActionName=function(){return"controlVariant"};return f});
//# sourceMappingURL=ControlVariant.js.map