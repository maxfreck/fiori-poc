/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/rta/plugin/Plugin","sap/ui/rta/util/validateText","sap/ui/dt/Overlay","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/rta/Utils","sap/ui/dt/DOMUtil","sap/ui/events/KeyCodes","sap/ui/dt/OverlayUtil"],function(jQuery,e,t,i,o,a,l,s,n,r,d){"use strict";var h="Â ";var _={errorStyleClass:"sapUiRtaErrorBg",_manageClickEvent:function(e){var t=e.getSource?e.getSource():e;if(t.isSelected()&&this.isRenameAvailable(t)&&this.isRenameEnabled([t])){t.attachBrowserEvent("click",_._onClick,this)}else{t.detachBrowserEvent("click",_._onClick,this)}},_setEditableFieldPosition:function(){if(this._oEditableField){jQuery(this._oEditableField).offset({left:n.getOffset(this._oEditableControlDomRef).left});jQuery(this._oEditableField).offset({top:n.getOffset(this._oEditableControlDomRef).top});this._oEditedOverlay.setSelected(true);this._oEditableField.focus()}},startEdit:function(t){this.setBusy(true);this._oEditedOverlay=t.overlay;var i=t.overlay.getElement();var r=this._oEditedOverlay.getDesignTimeMetadata();var h=r.getAssociatedDomRef(i,t.domRef);if(!s.isElementInViewport(h)){h.get(0).scrollIntoView()}this._oEditableControlDomRef=h.get(0);var E=typeof t.getTextMutators==="function"?t.getTextMutators(i):{getText:function(){return this._oEditableControlDomRef.textContent}.bind(this),setText:function(e){this._oEditableControlDomRef.textContent=e}.bind(this)};this._fnGetControlText=E.getText;this._fnSetControlText=E.setText;var c=0;var u=l.getOverlay(h.jquery?h.get(0).id:h.id);if(!u){u=this._oEditedOverlay;var f=a.getDomRef(i);var v=this._oEditableControlDomRef.parentNode;var b=f?parseInt(f.offsetWidth):"NaN";if(!isNaN(b)){var g=parseInt(this._oEditableControlDomRef.offsetWidth);var p=parseInt(v.offsetWidth);c=b-g;var y=Array.from(v.children);var m=y.filter(function(e){return n.isVisible(e)});if(c<0&&p){if(v.id!==f.id&&m.length===1&&m[0].id===this._oEditableControlDomRef.id&&b>p){c=b-p}else{c=0}}}}var C=document.createElement("div");C.classList.add("sapUiRtaEditableField");C.style.whiteSpace="nowrap";C.style.overflow="hidden";C.style.width="calc(100% - ("+c+"px))";u.getDomRef().append(C);var F=document.createElement("div");F.setAttribute("contentEditable","true");C.append(F);this._oEditableField=F;var S=this._fnGetControlText();if(S===""){this._fnSetControlText("_?_");this._oEditableField.textContent=""}else{this._oEditableField.textContent=S}this.setOldValue(_._getCurrentEditableFieldText.call(this));n.copyComputedStyle(this._oEditableControlDomRef,this._oEditableField);while(this._oEditableField.lastElementChild){this._oEditableField.removeChild(this._oEditableField.lastElementChild)}this._oEditableField.style.visibility="hidden";this._oEditableField.style["-moz-user-modify"]="read-write";this._oEditableField.style["-webkit-user-modify"]="read-write";this._oEditableField.style["-ms-user-modify"]="read-write";this._oEditableField.style["user-modify"]="read-write";this._oEditableField.style.userSelect="text";this._oEditableField.style["-webkit-user-select"]="text";this._oEditableField.style.textOverflow="clip";this._oEditableField.style.whiteSpace="nowrap";if(e.browser.name==="ed"&&i.getMetadata().getName()==="sap.ui.fl.variants.VariantManagement"){this._oEditableField.style.lineHeight="normal"}o.getMutationObserver().ignoreOnce({target:this._oEditableControlDomRef});this._FocusHandler=_._onEditableFieldFocus.bind(this);this._oBlurHandler=_._onEditableFieldBlur.bind(this);this._oKeyDownHandler=_._onEditableFieldKeydown.bind(this);this._oStopPropagationHandler=_._stopPropagation.bind(this);this._oEditableField.addEventListener("focus",this._FocusHandler,{once:true});this._oEditableField.addEventListener("blur",this._oBlurHandler);this._oEditableField.addEventListener("keydown",this._oKeyDownHandler);this._oEditableField.addEventListener("dragstart",this._oStopPropagationHandler);this._oEditableField.addEventListener("drag",this._oStopPropagationHandler);this._oEditableField.addEventListener("dragend",this._oStopPropagationHandler);this._oEditableField.addEventListener("click",this._oStopPropagationHandler);this._oEditableField.addEventListener("mousedown",this._oStopPropagationHandler);this._oEditableControlDomRef.style.visibility="hidden";jQuery(C).offset({left:n.getOffset(this._oEditableControlDomRef).left});_._setEditableFieldPosition.apply(this);this._oEditableField.style.visibility="";this._oEditableField.focus();this._aOverlaysWithScrollbar=d.findParentOverlaysWithScrollbar(u);this._aOverlaysWithScrollbar.forEach(function(e){e.attachScrollSynced(_._setEditableFieldPosition,this)}.bind(this));t.overlay.setSelected(true);sap.ui.getCore().getEventBus().publish("sap.ui.rta",t.pluginMethodName,{overlay:t.overlay,editableField:this._oEditableField})},_setDesignTime:function(e){this._aSelection=[];var i=this.getDesignTime();if(i){i.getSelectionManager().detachChange(_._onDesignTimeSelectionChange,this)}t.prototype.setDesignTime.apply(this,arguments);if(e){e.getSelectionManager().attachChange(_._onDesignTimeSelectionChange,this);this._aSelection=this.getSelectedOverlays()}},_onDesignTimeSelectionChange:function(e){var t=e.getParameter("selection");this._aSelection.forEach(_._manageClickEvent,this);t.forEach(_._manageClickEvent,this);this._aSelection=t},_stopPropagation:function(e){e.stopPropagation()},_preventDefault:function(e){e.preventDefault()},_onEditableFieldFocus:function(e){var t=e.target;var i=document.createRange();i.selectNodeContents(t);var o=window.getSelection();o.removeAllRanges();o.addRange(i)},_stopEdit:function(e,t){var i;this.setBusy(false);this._oEditableField.removeEventListener("blur",this._oBlurHandler);this._oEditableField.removeEventListener("focus",this._FocusHandler);this._oEditableField.removeEventListener("keydown",this._oKeyDownHandler);this._oEditableField.removeEventListener("dragstart",this._oStopPropagationHandler);this._oEditableField.removeEventListener("drag",this._oStopPropagationHandler);this._oEditableField.removeEventListener("dragend",this._oStopPropagationHandler);this._oEditableField.removeEventListener("click",this._oStopPropagationHandler);this._oEditableField.removeEventListener("mousedown",this._oStopPropagationHandler);if(this._fnGetControlText()==="_?_"){this._fnSetControlText("")}o.getMutationObserver().ignoreOnce({target:this._oEditableControlDomRef});this._oEditableControlDomRef.style.visibility="visible";if(e){i=this._oEditedOverlay;i.setSelected(true);i.focus()}this._aOverlaysWithScrollbar.forEach(function(e){e.detachScrollSynced(_._setEditableFieldPosition,this)}.bind(this));delete this._oEditableField;var a=this._oEditedOverlay.getDomRef()&&this._oEditedOverlay.getDomRef().querySelector(".sapUiRtaEditableField");if(a){a.remove()}delete this._oEditableControlDomRef;delete this._oEditedOverlay;delete this._bBlurOrKeyDownStarted;delete this._fnGetControlText;delete this._fnSetControlText;sap.ui.getCore().getEventBus().publish("sap.ui.rta",t,{overlay:i})},_onEditableFieldBlur:function(e){return _._handlePostRename.call(this,false,e)},_handlePostRename:function(e,t){if(!this._bBlurOrKeyDownStarted){this._oEditedOverlay.removeStyleClass(_.errorStyleClass);this._bBlurOrKeyDownStarted=true;if(t){_._preventDefault.call(this,t);_._stopPropagation.call(this,t)}return Promise.resolve().then(_._validateNewText.bind(this)).then(this._emitLabelChangeEvent.bind(this)).catch(function(e){if(e.message==="sameTextError"){return}throw e}).then(function(t){this.stopEdit(e);if(typeof t==="function"){t()}}.bind(this)).catch(function(t){return _._handleInvalidRename.call(this,t.message,e)}.bind(this))}return Promise.resolve()},_handleInvalidRename:function(e,t){return s.showMessageBox("error",e,{titleKey:"RENAME_ERROR_TITLE"}).then(function(){var e=this._oEditedOverlay;e.setIgnoreEnterKeyUpOnce(false);e.addStyleClass(_.errorStyleClass);this.stopEdit(t);this.startEdit(e)}.bind(this))},_validateNewText:function(){var e=this.getResponsibleElementOverlay(this._oEditedOverlay);var t=this.getAction(e);var o=_._getCurrentEditableFieldText.call(this);i(o,this.getOldValue(),t)},_onEditableFieldKeydown:function(e){switch(e.keyCode){case r.ENTER:this._oEditedOverlay.setIgnoreEnterKeyUpOnce(true);return _._handlePostRename.call(this,true,e);case r.ESCAPE:this._oEditedOverlay.removeStyleClass(_.errorStyleClass);this.stopEdit(true);_._preventDefault.call(this,e);break;case r.DELETE:case r.BACKSPACE:_._stopPropagation.call(this,e);break;default:}return Promise.resolve()},_getCurrentEditableFieldText:function(){var e=this._oEditableField?this._oEditableField.textContent.trim():"";return e===""?h:e},_onClick:function(e){var t=sap.ui.getCore().byId(e.currentTarget.id);if(this.isRenameEnabled([t])&&!e.metaKey&&!e.ctrlKey&&!e.shiftKey){this.startEdit(t);_._preventDefault.call(this,e)}},_exit:function(){if(this._oEditableControlDomRef){this.stopEdit(false)}}};return _},true);
//# sourceMappingURL=RenameHandler.js.map