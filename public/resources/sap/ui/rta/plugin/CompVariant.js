/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/MessageBox","sap/base/util/restricted/_omit","sap/base/util/isEmptyObject","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/rta/plugin/Plugin","sap/ui/rta/plugin/RenameHandler","sap/ui/rta/Utils","sap/ui/fl/write/api/ContextSharingAPI"],function(t,e,a,n,i,r,o,s,c){"use strict";var d=r.extend("sap.ui.rta.plugin.CompVariant",{metadata:{library:"sap.ui.rta",properties:{oldValue:{type:"string"}}}});function l(t,e,a,n){var r=t.getDesignTimeMetadata();var o=n||t.getElement();return Promise.resolve().then(function(){if(e.length===1){return this.getCommandFactory().getCommandFor(o,e[0],a,r)}var t;return this.getCommandFactory().getCommandFor(o,"composite").then(function(n){t=n;var i=[];e.forEach(function(t){i.push(this.getCommandFactory().getCommandFor(o,t,a[t],r))}.bind(this));return Promise.all(i).then(function(e){e.forEach(t.addCommand.bind(t));return t})}.bind(this))}.bind(this)).then(function(t){this.fireElementModified({command:t})}.bind(this)).catch(function(t){throw i.createError(e[0],t,"sap.ui.rta.plugin.CompVariant")})}function g(t){return t.getElement().getAllVariants()}function u(t){this.startEdit(t[0])}d.prototype.startEdit=function(t){var e=t.getDesignTimeMetadata().getData().variantRenameDomRef;o.startEdit.call(this,{overlay:t,domRef:e,pluginMethodName:"plugin.CompVariant.startEdit"})};d.prototype.stopEdit=function(t){o._stopEdit.call(this,t,"plugin.CompVariant.stopEdit")};d.prototype._emitLabelChangeEvent=function(){var t=this._oEditedOverlay;var e=t.getElement().getPresentVariantId();var a=o._getCurrentEditableFieldText.call(this);var n={newVariantProperties:{}};n.newVariantProperties[e]={name:a};l.call(this,t,["compVariantUpdate"],n)};function p(t){var n=t[0].getElement();var i={layer:this.getCommandFactory().getFlexSettings().layer,contextSharingComponentContainer:c.createComponent(this.getCommandFactory().getFlexSettings()),rtaStyleClass:s.getRtaStyleClassName()};n.openManageViewsDialogForKeyUser(i,function(i){if(!a(i)){l.call(this,t[0],["compVariantUpdate"],{newVariantProperties:e(i,["default"]),newDefaultVariantId:i.default,oldDefaultVariantId:n.getDefaultVariantId()})}}.bind(this))}function h(e,a,n){if(n===t.Action.CANCEL){return}var i=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var r=e.getElement();var o;if(n===i.getText("BTN_MODIFIED_VARIANT_SAVE")){f(r).then(function(t){o={compVariantSwitch:{targetVariantId:a,sourceVariantId:r.getPresentVariantId()},compVariantUpdate:t};l.call(this,e,["compVariantUpdate","compVariantSwitch"],o)}.bind(this))}if(n===i.getText("BTN_MODIFIED_VARIANT_DISCARD")){l.call(this,e,["compVariantSwitch"],{targetVariantId:a,sourceVariantId:r.getPresentVariantId(),discardVariantContent:true})}}function m(t){return g(t[0]).length>1}function V(e,a){var n=e[0];var i=n.getElement();if(i.getModified()){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var o=a.eventItem.getParameters().item.getProperty("key");t.warning(r.getText("MSG_CHANGE_MODIFIED_VARIANT"),{onClose:h.bind(this,n,o),actions:[r.getText("BTN_MODIFIED_VARIANT_SAVE"),r.getText("BTN_MODIFIED_VARIANT_DISCARD"),t.Action.CANCEL],emphasizedAction:r.getText("BTN_MODIFIED_VARIANT_SAVE"),styleClass:s.getRtaStyleClassName()})}else{l.call(this,n,["compVariantSwitch"],{targetVariantId:a.eventItem.getParameters().item.getProperty("key"),sourceVariantId:i.getPresentVariantId()})}}function f(t){return t.getPresentVariantContent().then(function(e){var a={onlySave:true,newVariantProperties:{}};a.newVariantProperties[t.getPresentVariantId()]={content:e};return a})}function A(t){var e=t[0].getElement();f(e).then(function(e){l.call(this,t[0],["compVariantUpdate"],e)}.bind(this))}function C(t){return t[0].getElement().currentVariantGetModified()}function E(t,e){var a=t[0].getElement();var n=c.createComponent(this.getCommandFactory().getFlexSettings());return new Promise(function(i){a.openSaveAsDialogForKeyUser(s.getRtaStyleClassName(),function(n){if(n){l.call(this,t[0],["compVariantSaveAs"],{newVariantProperties:{default:n.default,executeOnSelection:n.executeOnSelection,content:n.content,type:n.type,text:n.text,contexts:n.contexts},previousDirtyFlag:a.getModified(),previousVariantId:a.getPresentVariantId(),previousDefault:a.getDefaultVariantId(),activateAfterUndo:!!e})}i(n)}.bind(this),n)}.bind(this))}function v(t,e,a){var i=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(a===i.getText("BTN_CREATE_NEW_VIEW")){E.call(this,[n.getOverlay(t)],true).then(function(a){if(!a){t.activateVariant(e)}})}else{t.activateVariant(e)}}function I(e){var a=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var n=e[0];var i=n.getElement();var r=this.getAction(n);var o=i.getVariantManagement();var c=o.getModified();return r.handler(i,{styleClass:s.getRtaStyleClassName()}).then(function(e){if(e&&e.length){var i=e[0].changeSpecificData.content.persistencyKey;var r=o.getAllVariants();var d=r.find(function(t){return t.getVariantId()===o.getPresentVariantId()});if(d.isEditEnabled(this.getCommandFactory().getFlexSettings().layer)){l.call(this,n,["compVariantContent"],{variantId:e[0].changeSpecificData.content.key,newContent:e[0].changeSpecificData.content.content,persistencyKey:i,isModifiedBefore:c},o)}else{t.warning(a.getText("MSG_CHANGE_READONLY_VARIANT"),{onClose:v.bind(this,o,d.getVariantId()),actions:[a.getText("BTN_CREATE_NEW_VIEW"),t.Action.CANCEL],emphasizedAction:a.getText("BTN_CREATE_NEW_VIEW"),styleClass:s.getRtaStyleClassName()})}}}.bind(this))}d.prototype._isEditable=function(t){return this.hasStableId(t)&&!!this.getAction(t)};d.prototype.getMenuItems=function(t){var e=t[0];var a=e.getElement();var n=[];if(this.isAvailable([e])){if(this.getAction(e).changeType==="variantContent"){n.push({id:"CTX_COMP_VARIANT_CONTENT",text:this.getActionText(e,this.getAction(e)),handler:I.bind(this),enabled:true,rank:250,icon:"sap-icon://key-user-settings"})}else{var i=this.getCommandFactory().getFlexSettings().layer;var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var o=g(e);var s=o.find(function(t){return t.getVariantId()===a.getPresentVariantId()});if(s.isRenameEnabled(i)){n.push({id:"CTX_COMP_VARIANT_RENAME",text:r.getText("CTX_RENAME"),handler:u.bind(this),enabled:true,rank:210,icon:"sap-icon://edit"})}if(s.isEditEnabled(i)){n.push({id:"CTX_COMP_VARIANT_SAVE",text:r.getText("CTX_VARIANT_SAVE"),handler:A.bind(this),enabled:C,rank:220,icon:"sap-icon://save"})}n.push({id:"CTX_COMP_VARIANT_SAVE_AS",text:r.getText("CTX_VARIANT_SAVEAS"),handler:E.bind(this),enabled:true,rank:230,icon:"sap-icon://duplicate"});n.push({id:"CTX_COMP_VARIANT_MANAGE",text:r.getText("CTX_VARIANT_MANAGE"),handler:p.bind(this),enabled:true,rank:240,icon:"sap-icon://action-settings"});var c=o.map(function(t){var e=a.getPresentVariantId()===t.getVariantId();var n={id:t.getVariantId(),text:t.getText("variantName"),icon:e?"sap-icon://accept":"blank",enabled:!e};return n});n.push({id:"CTX_COMP_VARIANT_SWITCH",text:r.getText("CTX_VARIANT_SWITCH"),handler:V.bind(this),enabled:m,submenu:c,rank:250,icon:"sap-icon://switch-views"})}}return n};d.prototype.getActionName=function(){return"compVariant"};return d});
//# sourceMappingURL=CompVariant.js.map